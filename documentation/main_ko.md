# 파이프라인 실행 및 로직 (`main.py`)

이 문서는 데이터 처리, 중요도 지표 및 통계적 검증을 포함한 SOGNN 전극 절제 파이프라인의 6단계 실행 흐름을 설명합니다.

## 0단계: 데이터 로드 및 전처리

파이프라인은 SOGNN 원논문과 일치하는 **"one trial = one sample"** 접근 방식을 사용합니다.

1. **특징 추출**: `.mat` 파일에서 차분 엔트로피(DE) 특징을 로드합니다.
2. **정규화**: 패딩을 적용하기 *전*에 세션 내 모든 프레임에 대해 z-score 통계량(평균, 표준편차)을 계산합니다.
3. **시간적 정렬**: 트라이얼을 `T_FIXED = 64` 시간 프레임으로 제로 패딩하거나 자릅니다.
4. **재구성**: 샘플당 최종 출력 형태는 `(62, 5, 64)` (채널, 대역, 시간)입니다.

## 1 및 2단계: 훈련 및 앙상블

결과의 통계적 안정성을 보장하기 위해 파이프라인은 **다중 시드 앙상블(Multi-seed Ensemble)**을 사용합니다.

- **평가 프로토콜**: Leave-One-Subject-Out (LOSO). 각 피험자에 대해 14명의 데이터로 모델을 훈련하고 15번째 피험자로 테스트합니다.
- **앙상블**: LOSO 프로세스는 `n_seeds` 횟수(기본값 5)만큼 반복됩니다. 중요도 점수와 정확도는 시드 전체에 대해 평균화됩니다.
- **훈련 로직**: Adam 옵티마이저(`lr=1e-5`), 훈련 AUC(임계값 0.99) 및 정확도 기반 조기 종료, Cross-Entropy 손실을 사용합니다.

## 3단계: 전극 중요도 지표

파이프라인은 각 전극에 대해 중요도 점수를 계산합니다.

1. **순열 중요도 (Permutation Importance, PI)**: 특정 채널의 데이터를 샘플 간에 셔플했을 때 모델 정확도가 얼마나 하락하는지 측정합니다. 모델에 구애받지 않는 인과적으로 유효한 방법으로, 전극의 전역적 기여도를 포착합니다.
2. **감정별 중요도**: 각 감정 클래스별로 PI를 별도로 계산하여 감정별로 특화된 뇌 영역을 식별합니다.

## 4단계: 절제 실험 (Ablation Studies)

절제 실험은 정보가 제거됨에 따라 모델 성능이 어떻게 저하되는지 정량화합니다.

- **마스크 기반 (즉시 평가)**: 사전 훈련된 62채널 모델의 입력에 이진 마스크를 적용합니다. 많은 구성을 테스트하는 데 효율적입니다.
- **바닥부터 재훈련 (Retrain-from-scratch)**: 축소된 전극 서브셋만을 사용하여 새로운 SOGNN 모델을 초기화하고 훈련합니다. 모델이 축소된 특징 공간에 실제로 적응할 수 있는지 검증합니다.
- **점진적 절제 (Progressive Ablation)**: 평균 PI 점수(Grand Ranking)를 기반으로 전극을 하나씩(또는 단계별로) 제거합니다. 이를 통해 채널 수와 정확도 사이의 관계를 보여주는 곡선을 생성하고 **무릎 지점(Knee Point)**을 찾습니다.

## 5단계: 시각화 및 통계

결과는 다음과 같은 PDF 보고서로 종합됩니다.

- **토포그래픽 맵 (Topographic Maps)**: PI 중요도 점수를 2D 두피 투영도로 시각화합니다.
- **절제 곡선 (Ablation Curves)**: 채널 수 대비 정확도를 플로팅하며, 채널 추가의 효율이 급격히 떨어지는 **무릎 지점**을 강조합니다.
- **지역/뇌엽 테이블**: 해부학적 서브셋별 성능을 비교하는 막대 그래프와 히트맵을 생성합니다.
- **통계 검정**: 주요 구성(예: 전체 62채널 vs 10-20 시스템) 간에 **Wilcoxon 부호 순위 검정**을 수행하며, 다중 비교를 위해 **Holm-Bonferroni 교정**을 적용합니다.

## 명령줄 인터페이스 (CLI)

```bash
python main.py [options]
```

- `--data_root`: SEED-IV 특징 데이터 경로.
- `--n_seeds`: 앙상블 반복 횟수 (기본값: 5).
- `--retrain_ablation`: 비용이 많이 드는 '재훈련 기반 절제 실험' 활성화.
- `--notebook`: Jupyter/Colab 환경에 맞게 진행률 표시줄 형식을 변경.
